# PHASE_PLAN.md  
*(Ticket queue for the nine-agent ChatGPT o3 swarm â€“ each item is sized for one â‰¤ 20-minute pass.)*

> **How to use:**  
> 1. The **Conductor** pops the **next ticket** (top â†’ bottom).  
> 2. Feeds it to **PromptSmith**, then the appropriate specialist.  
> 3. When a ticket finishes (`response_status: DONE`), move to the next.  
> 4. If it fails, re-queue the same ticket with the failure report attached.  

---

## ğŸ“¦ Phase 0 â€” Bootstrapping

| ID       | Ticket (20 min max) | Deliverables / Acceptance Hint |
|----------|---------------------|--------------------------------|
| **P0-1** | **Blank mod skeleton** â€“ create RED4ext folder layout, `CMakeLists.txt`, `manifest.json`, empty `.reds` entry point. | Repo builds an empty `.archive` & prints â€œloadedâ€ on RED4ext console (no game logic yet). |
| **P0-2** | **Hot-reload harness** â€“ add `REDScripts` stub that logs on reload.                                                  | Running `ReloadAllMods()` produces console line twice in a row.                           |
| **P0-3** | **Networking stub lib** â€“ vendor ENet headers + minimal wrapper `Net_Init/Net_Shutdown()`.                           | `src/net/Net.cpp` & `Net.hpp` compile without undefined refs.                             |
| **P0-4** | **Headless server scaffold** â€“ CLI target `coop_dedicated.exe` that links Net stub and prints â€œDedicated upâ€.        | Executable starts and exits cleanly with `--help`.                                        |

---

## ğŸ§© Phase 1 â€” Core Session Pipeline

| ID  | Ticket | Deliverables / Acceptance Hint |
|-----|--------|--------------------------------|
| **P1-1** | **Packet enums & header** â€“ define `EMsg` and 4-byte `{u16 type,u16 size}` helpers. | `src/net/Packets.hpp` exists; helper tests in `tests/static/packet_header.json` pass lint. |
| **P1-2** | **Connection states** â€“ handshake â†’ lobby â†’ in-game; timeouts + ping. | State diagram comments + minimal switch in `Connection.cpp`. |
| **P1-3** | **Authoritative host flag** â€“ hard-code `gIsDedicatedAuthority = true`. | Constant visible in `NetConfig.hpp`. |
| **P1-4** | **Fixed tick-lock** â€“ expose `GameClock::GetCurrentTick()` at 32 ms. | Static test shows monotonic tick increments. |
| **P1-5** | **RNG seed sync** â€“ server sends `SeedPacket`; client sets `std::mt19937`. | Static test: same seed yields equal `rand()` outputs in doc comment. |
| **P1-6** | **Delta-snapshot schema** â€“ create `SnapshotWriter/Reader` skeleton with dirty-bit spec. | Spec commented; JSON sample in `tests/static/snapshot_schema.json`. |

---

## ğŸƒ Phase 2 â€” Player Replication Basics

| ID  | Ticket | Deliverables / Acceptance Hint |
|-----|--------|--------------------------------|
| **P2-1** | **Spawn / despawn RPCs** â€“ net spawn proxy avatars; despawn on leave. | `AvatarProxy.reds` added; doc example shows T-pose spawn. |
| **P2-2** | **Transform sync** â€“ serialize `pos,rot,vel` at 20 Hz with delta. | Struct `TransformSnap` in `Snapshot.hpp`. |
| **P2-3** | **Interpolation buffer** â€“ 100 ms buffer + Hermite sample stub. | `SnapshotInterpolator.reds` returns smoothed vec3 (static math check). |
| **P2-4** | **Client prediction & reconciliation** â€“ local authoritative move w/ correction hook. | Commented pseudo-math in `Prediction.reds`. |
| **P2-5** | **Health / armor model** â€“ add to snapshot; floating bar prefab. | `HealthBar.reds` UI stub in `/src/gui/`. |
| **P2-6** | **Ragdoll on disconnect** â€“ swap proxy to ragdoll + killfeed entry. | `OnPeerLeft()` sets `bRagdoll = true`. |

---

## ğŸ–¥ï¸ Phase 3 â€” UI & Lobby Flow

| ID  | Ticket | Deliverables / Acceptance Hint |
|-----|--------|--------------------------------|
| **P3-1** | **Main-menu button** â€“ inject â€œCO-OPâ€ into title screen. | Button opens placeholder panel. |
| **P3-2** | **Server-browser panel** â€“ scroll list fed by `/list` JSON; click selects. | `ServerList.reds` with sample JSON in `tests/static/serverlist.json`. |
| **P3-3** | **Join / Host buttons** â€“ host spins hidden dedicated process; join connects. | Successful local loopback connect demonstrated in log comment. |
| **P3-4** | **In-game chat overlay** â€“ toggle on `Enter`, reliable `ChatMsg` packet. | Chat log array length capped at 50 lines. |

---

## ğŸŒ Phase 4 â€” World & Quest Sync

| ID  | Ticket | Deliverables / Acceptance Hint |
|-----|--------|--------------------------------|
| **P4-1** | **Quest stage broadcast** â€“ hook `QuestSystem::AdvanceStage`. | `QuestSync.reds` contains `SendQuestStageMsg()`. |
| **P4-2** | **Trigger / scene sync** â€“ cutscene start/stop mirrored. | Comment: â€œAll players enter braindance togetherâ€. |
| **P4-3** | **Inventory authority** â€“ owner field for dropped items. | `ownerId` added to `ItemSnap` struct. |
| **P4-4** | **Net-safe pop-ups** â€“ replace single-player sleeps, braindance. | `PopupGuard.reds` disables freeze. |
| **P4-5** | **Savegame forking** â€“ co-op saves under `SavedGames/Coop/`. | Path constant in `SaveFork.cpp`. |

---

## ğŸ”« Phase 5 â€” Combat Fidelity

| ID  | Ticket | Deliverables / Acceptance Hint |
|-----|--------|--------------------------------|
| **P5-1** | **Hitscan lag compensation** â€“ rewind N ms on server confirm. | `LagComp.hpp` math comment includes formula. |
| **P5-2** | **Melee rollback buffer** â€“ 250 ms input buffer. | `Rollback.cpp` stub passes static time math test. |
| **P5-3** | **Quickhack sync** â€“ replicate target & cooldown. | `QuickhackSync.reds` added. |
| **P5-4** | **Armor dmg calc server-side** â€“ validate against hacks. | `DamageValidator.cpp` asserts bounds. |
| **P5-5** | **Shared NCPD heat** â€“ sync stars & spawn waves. | `HeatSync.reds` includes enum. |
| **P5-6** | **World state sync** â€“ time-of-day & weather. | `WeatherSync.reds` broadcasts every 30 s. |

---

## ğŸš— Phase 6 â€” Vehicles & Mounts

| ID  | Ticket | Deliverables / Acceptance Hint |
|-----|--------|--------------------------------|
| **P6-1** | **Vehicle spawn replication** â€“ server decides ID & transform. | `VehicleSnap` struct present. |
| **P6-2** | **Seat assignment RPC** â€“ `EnterVehicleMsg`. | Seat index comment range 0-3. |
| **P6-3** | **Deterministic car physics** â€“ authoritative server calculated. | `CarPhysics.cpp` includes fixed-step notes. |
| **P6-4** | **Collision damage sync** â€“ `VehicleHitMsg`. | Sample JSON fixture in `tests/static/vehicle_hit.json`. |

---

## ğŸ… Phase 7 â€” Simple Deathmatch Mode

| ID  | Ticket | Deliverables / Acceptance Hint |
|-----|--------|--------------------------------|
| **P7-1** | **DM ruleset toggle** â€“ `/gamemode dm` RPC resets map. | `GameModeManager.reds` toggles enum. |
| **P7-2** | **Frag counter & HUD** â€“ leaderboard panel (`Tab`). | `DMScoreboard.reds` UI stub. |
| **P7-3** | **Respawn system** â€“ random point, 5 s timer. | `Respawn.reds` delay const. |
| **P7-4** | **Match timer & win** â€“ 10-min round / 30 frags. | `MatchTimer.reds` comment describes flow. |
| **P7-5** | **Stat packet batching** â€“ batch kill/death per tick. | `StatBatch.cpp` packs â‰¤1 KB/s. |

---

## ğŸ§¹ Phase 8 â€” Hardening & Polish

| ID  | Ticket | Deliverables / Acceptance Hint |
|-----|--------|--------------------------------|
| **P8-1** | **Thread-safety pass** â€“ mutexes or lock-free ring buffers. | `ThreadSafeQueue.hpp` added. |
| **P8-2** | **Crash telemetry** â€“ zip dump + net log and prompt to send. | `CrashHandler.cpp` path comment. |
| **P8-3** | **Version hash check** â€“ compare CRCs on connect. | `VersionCheck.reds` rejects mismatches. |
| **P8-4** | **Master-server heartbeat** â€“ `/register` ping every 30 s. | `Heartbeat.cpp` example JSON. |
| **P8-5** | **Settings panel** â€“ tick-rate, interp delay, push-to-talk. | `CoopSettings.reds` saves `coop.ini`. |

---

### âœ… Completion Criteria

All tickets **P0-1 â†’ P8-5** return `response_status: DONE` with `static_checks: lint-ok` or better.  
At that point the project forms a feature-complete, statically sound co-op mod ready for manual runtime validation.

*End of PHASE_PLAN.md*
